<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>MChine</title>
</head>

<body>
  <form class="js-form">
    <input type="email" name="email">
    <input type="password" name="password">

    <button class="js-submit" type="submit">Login</button>
  </form>

  <script src="./node_modules/morphdom/dist/morphdom-umd.js"></script>
  <script type="module">
    import mchine from './node_modules/mchine/dist/index.m.js';
    import stateMachine from './stateMachine.m.js';

    const API = {
      login: () => new Promise((_, r) => setTimeout(r, 2000)),
    };

    const machine = mchine(stateMachine);
    const transition = machine.transition;

    machine.transition = (name, ...payload) => {
      transition(name, ...payload);
      const currentState = machine.getCurrentState()

      morphdom(form, `<form class="js-form">
        <input type="email"
              name="email"
              ${currentState === 'sending' ? 'disabled' : ''}
              value=${form.elements.email.value}>

        <input type="password"
              name="password"
              ${currentState === 'sending' ? 'disabled' : ''}
              value=${form.elements.password.value}>

        <button ${currentState === 'sending' ? 'disabled' : ''} class="js-submit" type="submit">Login</button>

        ${(currentState === 'error') ? '<span>Error</span>' : ''}
        ${(currentState === 'sending' ? `<span>Loading...</span>` : '')}
      </form>`)
    }

    const form = document.querySelector('.js-form')

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const form = event.target;

      const { email, password } = form.elements;

      machine.transition('login')

      API.login(email, password)
        .then(() => machine.transition('success'))
        .catch(() => machine.transition('error'))
    })
  </script>
</body>

</html>